%META:TOPICINFO{author="ProjectContributor" date="1224232370" format="1.1" reprev="1.1" version="$Rev$"}%
---+!! Send Email Plugin

*Allows to send e-mail through an e-mail form.*

%TOC%

---++ Usage

   * Create a form on the page.
      * Call =action= script =sendemail=
         * =action="%<nop>SCRIPTURL{sendemail}%/%<nop>WEB%/%<nop>TOPIC%"=
      * Required is a field with =name="to"=
      * Optional are the fields =cc=, =subject=, =body=, =template=,  =redirectto=, =successsection= and =errorsection=
      * The =from= field may be used but defaults to the address of the current user.
   * To show feedback write =%<nop>SENDEMAIL%= anywhere on the page where the feedback should appear.
      * Optionally pass parameters =feedbackSuccess= and =feedbackError=. 
        Default feedback messages are set below in [[%SCRIPTURLPATH{configure}%][configure]].
   * The =redirectto= is an url to redirect to a different landing page after the mail has been sent.
   * The =successsection= parameter optionally sets the named section to be extracted.
   * The =errorsection= parameter specifies the named section to be extracted when an error occured.
   * To customize the email, including its header, create a new template file (or topic) and set the
     =template= parameter to it. The default template is stored in the =sendemail.tmpl= file:
     <verbatim>
From: %FROM%
To: %TO%
CC: %CC%
Subject: %SUBJECT%

%BODY%
</verbatim>
  The tags =%<nop>FROM%=, =%<nop>TO%=, =%<nop>CC%=, =%<nop>SUBJECT%= and =%<nop>BODY%= are replaced with the respective url parameter when the email is created.

Note, that the =From=, =To= and =CC= parameters can be either an email address or a wiki user name, in which case the email address of that wiki user is used instead.

---+++ Restricting sending emails
To prevent this plugin to be used as open email relay, by default sending emails is prohibited. To send out mails, first set the mail addresses you want to allow to send to in [[%SCRIPTURLPATH{configure}%][configure]].

These preferences can be set:
   * ={Plugins}{SendEmailPlugin}{Permissions}{Allow}{MailTo}=
   * ={Plugins}{SendEmailPlugin}{Permissions}{Deny}{MailTo}=
   * ={Plugins}{SendEmailPlugin}{Permissions}{Allow}{MailFrom}=
   * ={Plugins}{SendEmailPlugin}{Permissions}{Deny}{MailFrom}=
   * ={Plugins}{SendEmailPlugin}{Permissions}{Allow}{MailCc}=
   * ={Plugins}{SendEmailPlugin}{Permissions}{Deny}{MailCc}=
   
Each can be a list of comma separated regular expressions that emails are checked against before allowing the mail to be sent.

Each =Deny= is evaluated after each =Allow=, so Deny settings overrule Allow settings.

---++++ Examples
   * Allow to send to:
      * Set ={SendEmailPlugin}{Permissions}{Allow}{MailTo}= to:
         * =john@tar.com= to only allow to send mails to John
         * =john@tar.com|mary@look.ca= to allow to send mails to John and Mary
         * =.*@tar.com= to send mails to any address at @tar.com
         * =.*@tar.com,mary@.*= to send mails to any address at @tar.com and to all Marys in the world
   * Deny to send to:
      * Set ={SendEmailPlugin}{Permissions}{Deny}{MailTo}= to:
         * =.*@tar.com= to deny to any address at @tar.com
         * =.*= to deny any address (no emails will be sent)

The same rules apply for =MailFrom= and =MailCc=.

---++ Examples
---+++ Example with plain html
%TWISTY{showlink=" Show code" hidelink=" Hide code" showimgleft="%ICONURLPATH{toggleopen}%" hideimgleft="%ICONURLPATH{toggleclose}%" mode="div"}%
<verbatim>
<form enctype="application/x-www-form-urlencoded" name="mailform" action="%SCRIPTURL{sendemail}%/%WEB%/%TOPIC%" method="POST">
<input type="hidden" name="successsection" value="thanks" />
<fieldset>
<legend><b>Send Email</b></legend>
<div class="foswikiFormSteps">
<div class="foswikiFormStep">
<h3>To:</h3>
<input class="foswikiInputField" id="to" name="to" size="30" type="text" value="%URLPARAM{"to"}%" />
</div>
<div class="foswikiFormStep">
<h3>CC:</h3>
<input type="text" class="foswikiInputField" id="cc" name="cc" size="30"  value="%URLPARAM{"cc"}%" />
</div>
<div class="foswikiFormStep">
<h3>Subject:</h3>
<input type="text" class="foswikiInputField" id="subject" name="subject" size="70" value="%URLPARAM{"subject"}%" />
</div>
<div class="foswikiFormStep">
<h3>Message:</h3>
<textarea class="foswikiInputField" cols="70" name="body" rows="6" style="width:100%">%URLPARAM{"body"}%</textarea>
</div>
<div class="foswikiFormStep">
<input type="submit" class="foswikiSubmit" value="Send" />
</div>
</div>
</fieldset>
</form>
%SENDEMAIL%
<!--
%STARTSECTION{"thanks"}%
---+!! Notification
%SENDEMAIL%
<input type="button" value="Ok" class="foswikiButton" onclick="window.location.href='%URLPARAM{"origurl" default="%SCRIPTURLPATH{view}%/%BASEWEB%/%BASETOPIC%"}%'" />
%ENDSECTION{"thanks"}%

-->
</verbatim>
%ENDTWISTY%


<form enctype="application/x-www-form-urlencoded" name="mailform" action="%SCRIPTURL{sendemail}%/%WEB%/%TOPIC%" method="POST">
<input type="hidden" name="successsection" value="thanks" />
<fieldset>
<legend><b>Send Email</b></legend>
<div class="foswikiFormSteps">
<div class="foswikiFormStep">
---+++!! To:
<input class="foswikiInputField" id="to" name="to" size="30" type="text" value="%URLPARAM{"to"}%" />
</div>
<div class="foswikiFormStep">
---+++!! CC:
<input type="text" class="foswikiInputField" id="cc" name="cc" size="30"  value="%URLPARAM{"cc"}%" />
</div>
<div class="foswikiFormStep">
---+++!! Subject:
<input type="text" class="foswikiInputField" id="subject" name="subject" size="70" value="%URLPARAM{"subject"}%" />
</div>
<div class="foswikiFormStep">
---+++!! Message:
<textarea class="foswikiInputField" cols="70" name="body" rows="6" style="width:100%">%URLPARAM{"body"}%</textarea>
</div>
<div class="foswikiFormStep">
<input type="submit" class="foswikiSubmit" value="Send" />
</div>
</div>
</fieldset>
</form>
%SENDEMAIL%

<style type="text/css">
#patternPage fieldset {
  border:1px solid #ddd;
  padding:1em
}
</style>

<!--
%STARTSECTION{"thanks"}%
---+!! Notification
%SENDEMAIL%
<input type="button" value="Ok" class="foswikiButton" onclick="window.location.href='%URLPARAM{"origurl" default="%SCRIPTURLPATH{view}%/%BASEWEB%/%BASETOPIC%"}%'" />
%ENDSECTION{"thanks"}%
-->

---+++ Example with <nop>FormPlugin
This form asks for user information and validates that the password confirmation matches the password.

%TWISTY{showlink=" Show code" hidelink=" Hide code" showimgleft="%ICONURLPATH{toggleopen}%" hideimgleft="%ICONURLPATH{toggleclose}%" mode="div"}%
<verbatim>
%STARTFORM{
name="mailForm"
action="%SCRIPTURL{sendemail}%/%WEB%/%TOPIC%"
method="POST"
onSubmit="return checkPasswords(this)"
}%
<fieldset style="border:1px solid #ddd; padding:1em">
<legend><b>Send Email</b></legend>
%RED%*%ENDCOLOR% All fields are required.
%FORMELEMENT{
name="To"
type="hidden"
title="To:"
default="me@myurl.com"
}%
%FORMELEMENT{
name="Subject"
type="hidden"
default="Account Request"
}%
%FORMELEMENT{
name="Name"
type="text"
mandatory="on"
title="Name (First and Last):"
}%
%FORMELEMENT{
name="Email"
type="text"
mandatory="on"
validate="email"
title="E-mail Address:"
}%
%FORMELEMENT{
name="Password"
type="password"
mandatory="on"
title="Password (caps sensitive):"
}%
%FORMELEMENT{
name="Confirm"
type="password"
mandatory="on"
title="Confirm your password:"
}%
%FORMELEMENT{
name="body"
type="textarea"
rows="10"
cols="80"
cssclass="foswikiHidden"
default="$Name
$Email
$Company
$Password
$Confirm"
}%
%FORMELEMENT{
type="submit"
buttonlabel="Send"
}%
</fieldset>
%ENDFORM%

%SENDEMAIL{feedbackSuccess="Request sent, we'll contact you shortly." feedbackError="Could not send your message, please contact us." }%

<script type="text/javascript">
//<![CDATA[
function checkPasswords(inForm) {
	if(inForm.Password.value != inForm.Confirm.value) {
		alert('Your passwords do not match. Please try again.');
		return false;
	}
	return true;
}
//]]>
</script>
</verbatim>
%ENDTWISTY%

%STARTFORM{
name="mailForm"
action="%SCRIPTURL{sendemail}%/%WEB%/%TOPIC%"
method="POST"
onSubmit="return checkPasswords(this)"
}%
<fieldset style="border:1px solid #ddd; padding:1em">
<legend><b>Send Email</b></legend>
%RED%*%ENDCOLOR% All fields are required.
%FORMELEMENT{
name="To"
type="hidden"
title="To:"
default="me@myurl.com"
}%
%FORMELEMENT{
name="Subject"
type="hidden"
default="Account Request"
}%
%FORMELEMENT{
name="Name"
type="text"
mandatory="on"
title="Name (First and Last):"
}%
%FORMELEMENT{
name="Email"
type="text"
mandatory="on"
validate="email"
title="E-mail Address:"
}%
%FORMELEMENT{
name="Password"
type="password"
mandatory="on"
title="Password (caps sensitive):"
}%
%FORMELEMENT{
name="Confirm"
type="password"
mandatory="on"
title="Confirm your password:"
}%
%FORMELEMENT{
name="body"
type="textarea"
rows="10"
cols="80"
cssclass="foswikiHidden"
default="$Name
$Email
$Company
$Password
$Confirm"
}%
%FORMELEMENT{
type="submit"
buttonlabel="Send"
}%
</fieldset>
%ENDFORM%

%SENDEMAIL{feedbackSuccess="Request sent, we'll contact you shortly." feedbackError="Could not send your message, please contact us." }%

<script type="text/javascript">
//<![CDATA[
function checkPasswords(inForm) {
	if(inForm.Password.value != inForm.Confirm.value) {
		alert('Your passwords do not match. Please try again.');
		return false;
	}
	return true;
}
//]]>
</script>

---++ FAQ
---+++ How do I send form fields?
If you have a form with the fields =Title= and =Summary= and want to post the values of these fields in the body of the e-mail, eiter:
   * put them in a hidden field:
   <verbatim>
<input type="hidden" name="body" value="Title: %FORMFIELD{"Title"}%, Summary: %FORMFIELD{"Summary"}%" />
</verbatim>
   * preserve linebreaks by putting them in a textarea:
   <verbatim>
<textarea name="body" class="foswikiHidden" cols="80" rows="6">
Title: %FORMFIELD{"Title"}%
Summary: %FORMFIELD{"Summary"}%
</textarea>
</verbatim>


#PluginTest
---++ Plugin Tests
   * !SendEmailPlugin is %IF{"context SendEmailPluginEnabled" then='%GREEN%enabled%ENDCOLOR%' else='%RED%not enabled%ENDCOLOR%'}%.


#PluginSettings
---++ Plugin Settings

   * One line description, is shown in the %SYSTEMWEB%.TextFormattingRules topic:
      * Set SHORTDESCRIPTION = Allows to send e-mail through an e-mail form

   * Other plugin settings are set in [[%SCRIPTURLPATH{configure}%][configure]] - look for ={SendEmailPlugin}= settings.
   * Note: by default any emailing is prohibited. Change the settings in configure to set to which addresses you allow mails to be sent from and to.

---++ CSS classes

| *Class name* | *Note* |
| =sendEmailPluginNotification=  | Used for feedback after sending a mail  |
| =sendEmailPluginError=         | Styles =sendEmailPluginNotification= in case of an error   |



---++ Plugin Installation Instructions

__Note:__ You do not need to install anything on the browser to use this
plugin. The following instructions are for the administrator who installs the
plugin on the server where Foswiki is running. 

   * Download the ZIP file from the Plugin web (see below)
   * Unzip ==%TOPIC%.zip== in your Foswiki installation directory. Content:
     | *File:* | *Description:* |
%$MANIFEST%

---++ Plugin Info

|  Plugin Author: | Foswiki:Main.ArthurClemens |
|  Copyright: | &copy; 2007-2009 Arthur Clemens; 2008 Michael Daum |
|  License: | GPL ([[http://www.gnu.org/copyleft/gpl.html][GNU General Public License]]) |
|  Plugin Version: | 1.4.1 (29 Mar 2009)  |
|  Change History: | <!-- versions below in reverse order -->&nbsp; |
|  29 Mar 2009 | 1.4.1 Arthur Clemens: removed default restrictions in =Deny= settings so that only the =Allow= setting needs to be set to send emails. |
|  21 Mar 2009 | 1.4 Arthur Clemens: moved topic and hardcoded settings to configure. | 
|  12 Mar 2009 | 1.3 Foswiki version. |
|  06 Nov 2008 | 1.2.3 Michael Daum: fixed CC emails; fixed css in docu |
|  17 Oct 2008 | 1.2.1 Michael Daum: added support for TWiki-5; fixed sending emails to login names |
|  26 Jun 2008 | 1.2.0 Michael Daum: \
                 added ALLOW/DENY preference settings to prevent this plugin from being used as an open spam relay; \
                 added =template= option allowing more control over email header etc; \
                 fixed mod_perl/perperl coding errors;\
                 sender address is the current user, it will default to the wikimaster's only as a last resort; \
                 allow user names in addition to plain email addresses in From, To and Cc; \
                 allow multiple users in To and Cc; \
                 added a =redirectto=, =successsection= and =errorsection= options to land on a different feedback page; \
                 reorganized code for lazy compilation |
|  16 may 2007 | 1.1.3 Foswiki:Main/ArthurClemens: fixed bug in bin script that caused form query data to get emptied. |
|  15 may 2007 | 1.1.2 Foswiki:Main/ArthurClemens: improved error notifications. |
|  13 May 2007 | 1.1.1 Foswiki:Main/ArthurClemens: changed sendmail script invocation to be called through bin script =sendemail=; added CSS styles for feedback notification; fixed typo 'feedbackSucces'. |
|  05 May 2007 | 1.0 First release. |
|  Foswiki Dependency: | %DEPENDENCIES% |
|  CPAN Dependencies: | none |
|  Other Dependencies: | none |
|  Perl Version: | 5.005 |
|  Plugin Home: | http://foswiki.org/Extensions/%TOPIC% |
|  Support: | http://foswiki.org/Support/%TOPIC% |
|  Development: | http://foswiki.org/Development/%TOPIC% |


